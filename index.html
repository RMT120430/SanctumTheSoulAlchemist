<!DOCTYPE html>
<!--
  Sanctum The Soul Alchemist
  Copyright (C) 2025 RMT120430
  Licensed under GNU GPL v3.0
  https://www.gnu.org/licenses/gpl-3.0.html
-->
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050507">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" href="icon-web.png"/>
    <title>Sanctum: The Soul Alchemistï¼ˆå¿ƒéˆè–åŸŸï¼šç…‰é‡‘è¡“å£«ï¼‰</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- å¼•å…¥ CryptoJS é€²è¡Œ AES åŠ å¯† -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        /* --- 0. æ ¸å¿ƒè®Šæ•¸ --- */
        :root {
            --bg-void: #050507;
            --panel-base: #0c0c10;
            --panel-border: #1a1a20;
            
            /* è‰²å½© */
            --color-solar: #c29d7c;
            --color-dusk: #345f4c;
            --color-sanctum: #6a708a;
            --color-void: #4b4a69;
            --color-alert: #774144;
            --color-text-dim: #666;

            /* å­—é«” */
            --font-rune: 'Courier New', monospace, sans-serif;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;

            /* å°èˆª */
            --nav-height: 70px;
            
            /* å…‰æšˆ */
            --glow-strength: 1px;
            --glow-spread: 8px;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: #000;
            color: #888;
            font-family: var(--font-ui);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }
        body::-webkit-scrollbar {display: none;}
        /* --- 1. å®¹å™¨ä½ˆå±€ --- */
        .app-window {
            width: 100%;
            max-width: 450px;
            background-color: var(--bg-void);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.8);
            border-left: 1px solid #111;
            border-right: 1px solid #111;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* å™ªéŸ³ç´‹ç† */
        .app-window::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 999;
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px 16px 100px 16px;
            z-index: 1;
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .content-area::-webkit-scrollbar { display: none; }

        /* --- 2. åº•éƒ¨å°èˆªåˆ— --- */
        .bottom-nav {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(12, 12, 16, 0.95);
            border-top: 1px solid var(--panel-border);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding-bottom: 10px;
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--color-text-dim);
            font-family: var(--font-rune); font-size: 0.7rem; /* å­—é«”ç¨å¾®ç¸®å°ä»¥å®¹ç´5å€‹ */
            cursor: pointer; transition: all 0.5s ease;
            width: 20%; /* 5å€‹é …ç›®ï¼Œæ¯å€‹20% */
            height: 100%;
        }

        .nav-icon {
            font-size: 1.3rem; margin-bottom: 4px; opacity: 0.5; transition: transform 0.5s;
        }

        .nav-item.active {
            color: var(--active-color);
            text-shadow: 0 0 8px var(--active-color);
        }
        .nav-item.active .nav-icon {
            opacity: 1; transform: translateY(-2px);
        }

        /* --- 3. æ¨¡çµ„é€šç”¨æ¨£å¼ --- */
        .module-card {
            background: var(--panel-base);
            border-left: 2px solid var(--active-color);
            border-top: 1px solid #222;
            border-right: 2px solid var(--active-color);
            border-bottom: 1px solid #222;
            padding: 20px;
            margin-bottom: 24px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            transition: border-color 0.8s ease, box-shadow 0.8s ease;
        }

        .module-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px;
            font-family: var(--font-rune); font-size: 0.7rem; letter-spacing: 1px;
            color: #666; text-transform: uppercase;
        }

        .cyber-input {
            background: #000; border: 1px solid #333;
            color: var(--active-color); padding: 12px; width: 100%;
            font-family: var(--font-rune); font-size: 0.8rem;
            margin-bottom: 10px;
            transition: box-shadow 0.5s;
        }
        .cyber-input:focus {
            outline: none; border-color: var(--active-color);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .action-btn {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            color: var(--active-color);
            padding: 12px; font-family: var(--font-rune); font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.5s;
        }
        .action-btn:hover { background: rgba(106, 112, 138, 0.1); text-shadow: 0 0 8px var(--active-color); }
        .action-btn:active { transform: scale(0.98); background: rgba(255,255,255,0.06); }

        /* --- è¨­å®šé é¢æ¨£å¼ --- */
        .settings-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; border-bottom: 1px solid #1a1a20; padding-bottom: 8px;
        }
        .settings-label {
            font-family: var(--font-rune); font-size: 0.8rem; color: #888;
        }
        .cyber-select {
            background: #050507; color: var(--color-text-dim);
            border: 1px solid #333; padding: 5px 10px;
            font-family: var(--font-rune); font-size: 0.8rem;
            outline: none;
            width: 80px; text-align: center;
        }

        /* --- PAGE 1: HOME --- */
        .page-section { display: none; animation: fadeIn 0.6s ease; }
        .page-section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stardust-counter {
            text-align: center; font-family: var(--font-rune);
            color: var(--active-color);
            border: 1px solid rgba(255,255,255,0.08);
            padding: 6px 16px; border-radius: 20px;
            display: inline-block; margin-bottom: 20px; font-size: 0.8rem;
            text-shadow: 0 0 8px var(--active-color);
        }

        .chrono-wheel {
            position: relative; width: 100%; height: 140px;
            display: flex; justify-content: center; align-items: center; margin: 10px 0 20px 0;
        }

        .locked-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 7, 0.75);
            backdrop-filter: blur(3px);
            z-index: 10;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.8s ease;
        }
        .module-card.locked .locked-overlay { opacity: 1; pointer-events: all; }

        .lock-icon-svg { width: 40px; height: 40px; margin-bottom: 12px; fill: none; stroke: var(--color-text-dim); stroke-width: 2; }
        .lock-text { font-family: var(--font-rune); font-size: 0.75rem; color: #888; text-align: center; line-height: 1.6; text-shadow: 0 0 16px var(--color-sanctum); }
        .lock-highlight { color: var(--color-dusk); display: block; margin-top: 5px; }

        .mana-container { width: 100%; height: 6px; background: #111; border-radius: 4px; overflow: hidden; margin: 15px 0; border: 1px solid #222; }
        .mana-bar { height: 100%; background: var(--active-color); width: 100%; transition: width 0.5s ease; box-shadow: 0 0 10px var(--active-color); }
        .mana-btn { width: 35px; height: 35px; border-radius: 50%; transition: 0.5s; border: 1px solid #333; background: transparent; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; text-shadow: 0 0 16px var(--color-sanctum); }
        .mana-btn:hover { background: rgba(106, 112, 138, 0.1); text-shadow: 0 0 8px var(--active-color); }

        /* --- PAGE 2: FOCUS (æ°´æ™¶åœ–é‘‘) --- */
        .timer-display { font-family: var(--font-rune); font-size: 3.8rem; font-weight: 500; color: #d0d0d0; text-align: center; margin: 25px 0; text-shadow: 0 0 8px var(--color-sanctum); }
        .crystal-slots { display: flex; justify-content: center; gap: 12px; margin-bottom: 15px; }
        .crystal { width: 12px; height: 12px; border: 1px solid #444; transform: rotate(45deg); transition: 0.5s; }
        .crystal.filled { background: var(--active-color); border-color: var(--active-color); box-shadow: 0 0 12px var(--active-color); }

        /* æ°´æ™¶åœ–é‘‘ Grid */
        .crystal-archive-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            row-gap: 45px;
            column-gap: 0px;
            padding: 30px;
            justify-items: center;
        }
        .archived-crystal {
            width: 24px; height: 24px;
            border: 1px solid var(--active-color);
            background: rgba(255,255,255,0.1);
            transform: rotate(45deg);
            cursor: pointer;
            transition: all 0.5s;
            box-shadow: 0 0 5px var(--active-color);
        }
        .archived-crystal:hover {
            background: var(--active-color);
            box-shadow: 0 0 15px var(--active-color);
        }

        /* --- PAGE 3: ALCHEMY --- */
        .archive-item {
            background: rgba(20, 20, 25, 0.4); border: 1px solid #222; padding: 15px;
            cursor: pointer; transition: all 0.5s; position: relative; overflow: hidden; margin-bottom: 10px;
        }
        .archive-item::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 2px; background: #444; transition: 0.5s; }
        .archive-item.expanded { background: #15151a; border-color: var(--color-solar); }
        .archive-item.expanded::before { background: var(--color-solar); box-shadow: 0 0 8px var(--color-solar); }
        .archive-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease; font-size: 0.8rem; color: #888; margin-top: 0; border-top: 1px dashed #333; }
        .archive-item.expanded .archive-details { max-height: 120px; margin-top: 10px; padding-top: 10px; }
        
        .delete-btn-small {
            position: absolute; top: 25px; right: 10px;
            color: var(--color-alert); font-size: 1.2rem; cursor: pointer; opacity: 0.6;
        }
        .delete-btn-small:hover { opacity: 1; text-shadow: 0 0 8px var(--color-alert); }

        /* --- PAGE 4: RELEASE --- */
        .incinerator-area { width: 100%; height: 150px; background: #000; border: 1px solid #333; color: #444; padding: 15px; font-family: var(--font-rune); resize: none; margin-bottom: 15px; line-height: 1.5; }
        .incinerator-area:focus { outline: none; border-color: var(--color-alert); }
        .btn-alert { border-color: rgba(166, 93, 102, 0.3); color: var(--color-alert); }
        .btn-alert:hover { background: rgba(166, 93, 102, 0.1); text-shadow: 0 0 8px var(--color-alert); }

        /* --- PAGE 5: SETTINGS --- */
        .settings-status {
            text-align: center; margin-bottom: 20px; font-family: var(--font-rune);
        }
        .status-badge {
            display: inline-block; padding: 5px 12px; font-size: 0.8rem;
            border: 1px solid #333; color: #888;
        }
        .status-badge.unlocked {
            border-color: var(--color-dusk); color: var(--color-dusk);
            text-shadow: 0 0 5px var(--color-dusk);
        }
        .status-badge.locked {
            border-color: var(--color-alert); color: var(--color-alert);
            text-shadow: 0 0 5px var(--color-alert);
        }

        /* --- Modal --- */
        /* Z-index èª¿æ•´: æ™®é€š Modal 200, è­¦å‘Š/ç¢ºèª Modal 300 ç¢ºä¿è¦†è“‹ */
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal.open { display: flex; animation: fadeIn 0.3s; }
        
        /* å¢åŠ é€šç”¨ Alert/Confirm çš„ Z-Index */
        #generic-alert-modal, #generic-confirm-modal { z-index: 300; }

        .modal-box { width: 85%; background: #111; padding: 25px; border-left: 2px solid var(--active-color); border-top: 1px solid #222; border-right: 2px solid var(--active-color); border-bottom: 1px solid #222; text-align: center; box-shadow: 0 0 30px rgba(0,0,0,0.5); position: relative; }

    </style>
</head>
<body>

<div class="app-window">
    
    <div class="content-area">
        
        <!-- PAGE 1: HOME -->
        <div id="page-home" class="page-section active">
            <div style="text-align: center; margin-top: 15px;">
                <div class="stardust-counter">âœ¦ STARDUST: <span id="stardust-display">0</span></div>
            </div>

            <div class="chrono-wheel">
                <svg width="220" height="110" viewBox="0 0 220 110">
                    <path d="M 10 110 A 100 100 0 0 1 210 110" fill="none" stroke="#222" stroke-width="2" />
                    <path id="sun-path" d="M 10 110 A 100 100 0 0 1 10 110" fill="none" stroke="var(--active-color)" stroke-width="3" style="filter: drop-shadow(0 0 4px var(--active-color));" />
                    <circle id="celestial-body" cx="10" cy="110" r="5" fill="#000" stroke="var(--active-color)" stroke-width="2" />
                </svg>
                <div style="position: absolute; bottom: 0; text-align:center; font-family: var(--font-rune); font-size:0.9rem; color: var(--active-color); text-shadow: 0 0 16px var(--active-color);">
                    <span id="phase-name">LOADING...</span>
                    <div id="real-time" style="text-align:center; color: #666; font-size: 1.8rem; margin-top: 5px; text-shadow: 0 0 8px var(--color-sanctum);">00:00</div>
                </div>
            </div>

            <!-- Social Mana -->
            <div class="module-card" id="module-social">
                <div class="locked-overlay" id="social-lock">
                    <svg class="lock-icon-svg" viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm11 14H4V10h16v10z"/></svg>
                    <div class="lock-text">[ SANCTUM ACTIVE (çµç•Œå•Ÿå‹•) ]<br>ã€Œå¤–éƒ¨å¹²æ“¾å·²é˜»æ“‹ã€‚ã€<br><span class="lock-highlight">ã€Œä¸–ç•Œæ­£åœ¨ç‚ºä½ é‡å»ºï¼Œç¾åœ¨éŒ¯éä¹Ÿæ²’é—œä¿‚ã€‚ã€</span></div>
                </div>
                <div class="module-header"><span>â§« SOCIAL MANA</span><span>SHIELD INTEGRITY âŸ </span></div>
                <div class="mana-container"><div class="mana-bar" id="mana-bar"></div></div>
                <div class="mana-controls" style="display:flex; justify-content:space-evenly; align-items:center;">
                    <button class="mana-btn" onclick="adjustMana(-10)">-</button><span style="font-family: var(--font-rune); font-size: 0.8rem; color: #555; line-height: 35px; text-shadow: 0 0 16px var(--color-sanctum);">ENERGY</span><button class="mana-btn" onclick="adjustMana(10)">+</button>
                </div>
            </div>
            <div style="text-align:center; color:#444; font-family:var(--font-rune); font-size:0.8rem; margin-top:30px; text-shadow: 0 0 24px var(--color-sanctum);">
                "You're not lost, but keeping watch over tranquility."<br>ã€Œä½ ä¸æ˜¯åœ¨æµæµªï¼Œè€Œæ˜¯åœ¨å®ˆè­·å¯§éœã€‚ã€
            </div>
        </div>

        <!-- PAGE 2: FOCUS -->
        <div id="page-focus" class="page-section">
            <div class="module-card">
                <div class="module-header"><span>â§« POMODORO REACTOR</span><span id="cycle-status">READY âŸ </span></div>
                <!-- å¾ªç’°æŒ‡ç¤ºç‡ˆ (4é¡†ä¸€å¾ªç’°) -->
                <div class="crystal-slots">
                    <div class="crystal" id="c1"></div><div class="crystal" id="c2"></div><div class="crystal" id="c3"></div><div class="crystal" id="c4"></div>
                </div>
                <div class="timer-display" id="timer">25:00</div>
                <button class="action-btn" style="text-shadow: 0 0 16px var(--active-color);" id="btn-start" onclick="openTaskModal()">CRYSTAL CHARGING (æ°´æ™¶å……èƒ½)</button>
                <button class="action-btn" style="margin-top: 10px; border: none; color: #666; font-size: 0.8rem; text-shadow: none;" onclick="reduceDifficulty()">â–¼ REDUCE (æ™‚é–“æ¸›åŠ) â–¼</button>
                <button class="action-btn" style="margin-top: 5px; border: none; color: #444; font-size: 0.7rem; text-shadow: none;" onclick="resetCrystalSlots()">[ RESET (é‡ç½®æ°´æ™¶é€²åº¦) ]</button>
            </div>

            <!-- æ°´æ™¶åœ–é‘‘å€ -->
            <div style="padding: 0 5px;">
                <div class="module-header" style="margin-bottom: 10px;"><span>â§« CRYSTAL ARCHIVE</span><span>COLLECTION âŸ </span></div>
                <div id="crystal-archive" class="crystal-archive-grid">
                    <!-- JS ç”Ÿæˆæ°´æ™¶ -->
                </div>
                <div style="margin-top: 30px; text-align: center; font-size: 0.8rem; color: #444; text-decoration: underline; cursor: pointer;" onclick="clearCrystalLogs()">[ RESET (æ¸…ç©ºæ°´æ™¶æ”¶è—) ]</div>
            </div>
        </div>

        <!-- PAGE 3: ALCHEMY -->
        <div id="page-alchemy" class="page-section">
            <div class="module-card">
                <div class="module-header"><span>â§« TRANSMUTATION</span><span>INPUT âŸ </span></div>
                <input type="text" style="color:#444; text-align:center;" class="cyber-input" id="alchemy-raw" placeholder="Material (ç…‰åŒ–æ‰€éœ€åŸæ–™)">
                <input type="text" style="color:#444; text-align:center;" class="cyber-input" id="alchemy-refined" placeholder="Target (æ¬²ç…‰åŒ–çš„çµæœ)">
                <button class="action-btn" style="text-shadow: 0 0 16px var(--active-color);" onclick="transmute()">TO TRANSMUTE (ç…‰åŒ–)</button>
            </div>

            <div style="padding: 0 5px;">
                <div class="module-header" style="margin-bottom: 10px;"><span>â§« THE ARCHIVES</span><span>DATA LOGS âŸ </span></div>
                <div id="archive-shelf" style="margin-top: 15px;"></div>
                <div style="margin-top: 30px; text-align: center; font-size: 0.8rem; color: #444; text-decoration: underline; cursor: pointer;" onclick="clearAlchemyLogs()">[ RESET (æ¸…ç©ºç…‰é‡‘çˆ) ]</div>
            </div>
        </div>

        <!-- PAGE 4: RELEASE -->
        <div id="page-release" class="page-section">
            <div class="module-card" style="border-left: 2px solid var(--color-alert); border-top: 1px solid #222; border-right: 2px solid var(--color-alert); border-bottom: 1px solid #222;">
                <div class="module-header"><span>â§« INCINERATOR</span><span>AUTO-WIPE âŸ </span></div>
                <textarea class="incinerator-area" id="confess-text" style="text-align:center; font-size:0.8rem;" placeholder="å¯«ä¸‹æƒ…ç·’...è–åŸŸå°‡åœ¨æ¥æ”¶å¾Œï¼Œç‚ºä½ æ°¸ä¹…éŠ·æ¯€å®ƒå€‘ã€‚"></textarea>
                <button class="action-btn btn-alert" onclick="shredEmotion()">INCINERATE (ç„šæ¯€)</button>
            </div>
            <div style="text-align:center; color:#444; font-size:0.8rem; margin-top:30px; font-family:var(--font-rune); text-shadow: 0 0 24px var(--color-sanctum);">"It isn't your fault, you're not so bad."<br>ã€Œä½ ä¸¦ä¸ç³Ÿç³•ï¼Œé€™ä¸æ˜¯ä½ çš„éŒ¯ã€‚ã€</div>
        </div>

        <!-- PAGE 5: SETTINGS -->
        <div id="page-settings" class="page-section">
            <div class="module-card">
                <div class="module-header"><span>â§« SECURITY PROTOCOL</span><span>AES-256 âŸ </span></div>
                
                <div class="settings-status">
                    è–åŸŸç‹€æ…‹: <span id="lock-status" class="status-badge locked">LOCKED (åŠ å¯†ä¸­)</span>
                </div>

                <p style="font-size: 0.8rem; color: #666; text-align: center; margin-bottom: 15px;">
                    è¨­å®šå¯†ç¢¼ä»¥è§£é–åŠ å¯†å…§å®¹ã€‚<br>è‹¥æœªè§£é–ï¼Œæ‰€æœ‰ç´€éŒ„å°‡é¡¯ç¤ºç‚ºäº‚ç¢¼ã€‚
                </p>

                <input type="password" style="color: #444; text-align:center;" class="cyber-input" id="settings-password" placeholder="è¼¸å…¥å¯†ç¢¼ (Access Key)">
                
                <div style="display:flex; gap:10px;">
                    <button class="action-btn" style="border:none" onclick="toggleLock(true)">LOCK (ä¸Šé–)</button>
                    <button class="action-btn" style="border:none" onclick="toggleLock(false)">UNLOCK (è§£é–)</button>
                </div>
            </div>

            <!-- æ™‚é–“èˆ‡éšæ®µè¨­å®š -->
            <div class="module-card">
                <div class="module-header"><span>â§« PHASE SETTINGS</span><span>CALIBRATION âŸ </span></div>
                
                <p style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 15px;">
                    è¨­å®šæ¯å€‹éšæ®µçš„é–‹å§‹æ™‚é–“ (24h)<br>è–åŸŸå°‡ä¾ç…§ä½ çš„ä½œæ¯é‡å¡‘ã€‚
                </p>

                <div class="settings-row">
                    <span class="settings-label" style="color:var(--color-solar)">SOLAR (å‰µé€ )</span>
                    <select id="phase-solar-input" class="cyber-select"></select>
                </div>

                <div class="settings-row">
                    <span class="settings-label" style="color:var(--color-dusk)">DUSK (ç¤¾äº¤)</span>
                    <select id="phase-dusk-input" class="cyber-select"></select>
                </div>

                <div class="settings-row">
                    <span class="settings-label" style="color:var(--color-sanctum)">SANCTUM (çµç•Œ)</span>
                    <select id="phase-sanctum-input" class="cyber-select"></select>
                </div>

                <div class="settings-row">
                    <span class="settings-label" style="color:var(--color-void)">VOID (ä¼‘çœ )</span>
                    <select id="phase-void-input" class="cyber-select"></select>
                </div>
                
                <p style="font-size: 0.7rem; color: #666; text-align: center; margin-top: 5px;">
                    SANCTUM èˆ‡ VOID éšæ®µå°‡å•Ÿå‹•çµç•Œã€‚
                </p>

                <div style="display:flex; gap:10px; margin-top:15px;">
                    <button class="action-btn" style="border:none; color:#888; text-shadow: none;" onclick="resetPhaseSettings()">RESET</button>
                    <button class="action-btn" style="border:none;" onclick="savePhaseSettings()">SAVE</button>
                </div>
            </div>
            <!-- è³‡æ–™ç®¡ç†å€å¡Š (Data Management) -->
            <div class="module-card" style="margin-bottom: 80px;">
                <div class="module-header"><span>â§« DATA MANAGEMENT</span><span>CONTROL âŸ </span></div>
                
                <p style="font-size: 0.8rem; color: #888; text-align: center; margin-bottom: 15px;">
                    å‚™ä»½æˆ–é‚„åŸè–åŸŸæ•¸æ“šã€‚<br>åŒ…å«ç´€éŒ„ã€å¯†ç¢¼é‘°åŒ™èˆ‡æ™‚é–“è¨­å®šã€‚
                </p>

                <div style="display:flex; flex-direction:column; gap:10px;">
                    <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                    <button class="action-btn" style="border:none; color:var(--active-color); font-family: var(--font-rune); font-weight:300; margin-top:0;" onclick="exportData()">
                        [ EXPORT ARCHIVE (åŒ¯å‡ºå‚™ä»½) ]
                    </button>

                    <!-- åŒ¯å…¥æŒ‰éˆ• (è§¸ç™¼éš±è—çš„ input) -->
                    <button class="action-btn" style="border:none; color:var(--active-color); font-family: var(--font-rune); font-weight:300; margin-top:0;" onclick="document.getElementById('import-file-input').click()">
                        [ IMPORT ARCHIVE (åŒ¯å…¥å‚™ä»½) ]
                    </button>
                    <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="importData(this)">

                    <!-- æ¸…é™¤æŒ‰éˆ• -->
                    <button class="action-btn btn-alert" style="border:none; margin-top: 10px;" onclick="wipeAllData()">
                        [ WIPE SYSTEM (æ¸…é™¤æ‰€æœ‰è³‡æ–™) ]
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('home')"><div class="nav-icon">â¦¿</div><span>è–åŸŸ</span></div>
        <div class="nav-item" onclick="switchTab('focus')"><div class="nav-icon">âŸ¡</div><span>æ°´æ™¶</span></div>
        <div class="nav-item" onclick="switchTab('alchemy')"><div class="nav-icon">â‰‹</div><span>ç…‰é‡‘</span></div>
        <div class="nav-item" onclick="switchTab('release')"><div class="nav-icon">âš</div><span>ç„šæ¯€</span></div>
        <div class="nav-item" onclick="switchTab('settings')"><div class="nav-icon">â«¸</div><span>è¨­å®š</span></div>
    </div>

    <!-- Task Modal -->
    <div class="modal" id="task-modal">
        <div class="modal-box">
            <h3 style="color:var(--active-color); font-family: var(--font-rune); font-weight:300; margin-top:0; text-shadow: 0 0 8px var(--active-color);">CRYSTAL CHARGING</h3>
            <p style="color:#888; font-family: var(--font-rune); font-size:0.8rem;">ç‚ºäº†å•Ÿå‹•é€™é¡†æ°´æ™¶ï¼Œ<br>ä½ ç¾åœ¨åªéœ€è¦åšå“ªä¸€ä»¶<b>å°äº‹</b>...å†å°éƒ½ç„¡å¦¨ã€‚</p>
            <input type="text" class="cyber-input" id="micro-task-input" style="color:#666; font-family: var(--font-rune); font-size:0.8rem;" placeholder="ä¾‹å¦‚: æ‰“é–‹æª”æ¡ˆ...">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="action-btn" style="color:#666; text-shadow: none;" onclick="closeTaskModal()">CANCEL</button>
                <button class="action-btn" onclick="startTimer()">CONFIRM</button>
            </div>
        </div>
    </div>

    <!-- Crystal Detail Modal -->
    <div class="modal" id="crystal-detail-modal">
        <div class="modal-box">
            <h3 style="color:var(--active-color); font-family: var(--font-rune); font-weight:300; margin-top:0;">CRYSTAL DATA</h3>
            <div id="crystal-detail-content" style="color:#888; font-family: var(--font-rune); margin: 20px 0; font-size: 0.9rem;"></div>
            <div style="display:flex; gap:10px; justify-content: center;">
                <button class="action-btn" style="color:#666; text-shadow: none;" onclick="document.getElementById('crystal-detail-modal').classList.remove('open')">CLOSE</button>
                <button class="action-btn btn-alert" id="btn-delete-crystal">DELETE</button>
            </div>
        </div>
    </div>

    <!-- Generic Alert Modal -->
    <div class="modal" id="generic-alert-modal">
        <div class="modal-box">
            <h3 id="alert-title" style="color:var(--active-color); font-family: var(--font-rune); font-weight:300; margin-top:0; text-shadow: 0 0 8px var(--active-color);">SYSTEM NOTICE</h3>
            <p id="alert-message" style="color:#888; font-family: var(--font-rune); font-size: 0.9rem; margin: 20px 0;"></p>
            <button class="action-btn" onclick="document.getElementById('generic-alert-modal').classList.remove('open')">ALRIGHT</button>
        </div>
    </div>

    <!-- Generic Confirm Modal -->
    <div class="modal" id="generic-confirm-modal">
        <div class="modal-box">
            <h3 id="confirm-title" style="color:var(--color-alert); font-family: var(--font-rune); font-weight:300; margin-top:0; text-shadow: 0 0 8px var(--color-alert);">CONFIRMATION REQUIRED</h3>
            <p id="confirm-message" style="color:#888; font-family: var(--font-rune); font-size: 0.9rem; margin: 20px 0;"></p>
            <div style="display:flex; gap:10px;">
                <button class="action-btn" style="border-color: #444; color: #888; text-shadow: none;" onclick="document.getElementById('generic-confirm-modal').classList.remove('open')">CANCEL</button>
                <button class="action-btn btn-alert" id="confirm-yes-btn">CONFIRM</button>
            </div>
        </div>
    </div>

    <audio id="timer-sound" src="timer.mp3" preload="auto"></audio>
</div>

<script>
    // ===== è‡ªå®šç¾© Alert èˆ‡ Confirm é‚è¼¯ =====
    
    function showCustomAlert(message, title = "SYSTEM NOTICE") {
        document.getElementById('alert-title').innerText = title;
        document.getElementById('alert-message').innerText = message;
        document.getElementById('generic-alert-modal').classList.add('open');
    }

    // ç”¨æ–¼å­˜å„²ç¢ºèªè¦–çª—çš„ç•¶å‰ Callback
    let confirmCallback = null;

    function showCustomConfirm(message, onConfirm, title = "CONFIRMATION REQUIRED") {
        document.getElementById('confirm-title').innerText = title;
        document.getElementById('confirm-message').innerText = message;
        confirmCallback = onConfirm;
        document.getElementById('generic-confirm-modal').classList.add('open');
    }

    // ç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶ (åªéœ€åŸ·è¡Œä¸€æ¬¡)
    document.getElementById('confirm-yes-btn').addEventListener('click', function() {
        if (confirmCallback) {
            confirmCallback();
        }
        document.getElementById('generic-confirm-modal').classList.remove('open');
        confirmCallback = null; // é‡ç½®
    });


    // ===== ä¿®æ­£å¾Œçš„åŠ å¯†ç³»çµ± =====
    let currentPassword = localStorage.getItem('app_password') || ""; // æŒä¹…åŒ–å¯†ç¢¼
    let isUnlocked = localStorage.getItem('is_unlocked') === 'true'; // æŒä¹…åŒ–è§£é–ç‹€æ…‹

    // é—œéµä¿®æ­£: åŠ å¯†å‡½æ•¸ - ç¸½æ˜¯ä½¿ç”¨å¯†ç¢¼åŠ å¯†(å¦‚æœæœ‰å¯†ç¢¼)
    function encryptData(text) {
        if (!text) return "";
        if (!currentPassword) return text; // ç„¡å¯†ç¢¼æ™‚æ˜æ–‡å­˜å„²
        
        try {
            return CryptoJS.AES.encrypt(text, currentPassword).toString();
        } catch (e) { 
            console.error('Encryption error:', e);
            return text; 
        }
    }

    // é—œéµä¿®æ­£: è§£å¯†å‡½æ•¸
    function decryptData(ciphertext) {
        if (!ciphertext) return "";
        if (!currentPassword) return ciphertext; // ç„¡å¯†ç¢¼ç›´æ¥è¿”å›
        if (!isUnlocked) return "â§«ğ“”ğ“£âŸ ğ“Ÿğ“¨â§«ğ“¡ğ“’âŸ ğ“ğ“”â§«"; // ä¸Šé–ç‹€æ…‹é¡¯ç¤ºåŠ å¯†æ¨™è¨˜
        
        try {
            const bytes = CryptoJS.AES.decrypt(ciphertext, currentPassword);
            const originalText = bytes.toString(CryptoJS.enc.Utf8);
            return originalText || "DECRYPTION FAILED";
        } catch (e) {
            console.error('Decryption error:', e);
            return "DECRYPTION FAILED";
        }
    }

// 4. æª¢æ¸¬æ–‡æœ¬æ˜¯å¦å·²åŠ å¯†
function isEncrypted(text) {
    if (!text) return false;
    // AESåŠ å¯†å¾Œçš„æ–‡æœ¬é€šå¸¸ä»¥ "U2FsdGVk" é–‹é ­ (Base64ç·¨ç¢¼çš„ç‰¹å¾µ)
    return text.startsWith('U2FsdGVk');
}

// 5. é‡æ–°åŠ å¯†æ‰€æœ‰èˆŠè³‡æ–™
function reEncryptAllData(oldPassword, newPassword) {
    // é‡æ–°åŠ å¯† Alchemy Logs
    if (State.alchemyLogs.length > 0) {
        State.alchemyLogs = State.alchemyLogs.map(log => {
            let rawText = log.raw;
            let refinedText = log.refined;
            
            // å¦‚æœæœ‰èˆŠå¯†ç¢¼,å…ˆè§£å¯†
            if (oldPassword) {
                try {
                    const rawBytes = CryptoJS.AES.decrypt(rawText, oldPassword);
                    rawText = rawBytes.toString(CryptoJS.enc.Utf8) || rawText;
                    
                    const refinedBytes = CryptoJS.AES.decrypt(refinedText, oldPassword);
                    refinedText = refinedBytes.toString(CryptoJS.enc.Utf8) || refinedText;
                } catch (e) {
                    console.error('è§£å¯†èˆŠè³‡æ–™å¤±æ•—:', e);
                }
            }
            
            // ç”¨æ–°å¯†ç¢¼é‡æ–°åŠ å¯†
            return {
                ...log,
                raw: newPassword ? CryptoJS.AES.encrypt(rawText, newPassword).toString() : rawText,
                refined: newPassword ? CryptoJS.AES.encrypt(refinedText, newPassword).toString() : refinedText
            };
        });
    }
    
    // é‡æ–°åŠ å¯† Crystal Logs
    if (State.crystalLogs.length > 0) {
        State.crystalLogs = State.crystalLogs.map(log => {
            let taskText = log.task;
            
            // å¦‚æœæœ‰èˆŠå¯†ç¢¼,å…ˆè§£å¯†
            if (oldPassword) {
                try {
                    const taskBytes = CryptoJS.AES.decrypt(taskText, oldPassword);
                    taskText = taskBytes.toString(CryptoJS.enc.Utf8) || taskText;
                } catch (e) {
                    console.error('è§£å¯†èˆŠè³‡æ–™å¤±æ•—:', e);
                }
            }
            
            // ç”¨æ–°å¯†ç¢¼é‡æ–°åŠ å¯†
            return {
                ...log,
                task: newPassword ? CryptoJS.AES.encrypt(taskText, newPassword).toString() : taskText
            };
        });
    }
    
    saveData(); // ä¿å­˜é‡æ–°åŠ å¯†å¾Œçš„è³‡æ–™
}

// 6. å®Œå…¨ä¿®æ­£çš„ toggleLock å‡½æ•¸ (å·²æ”¹ç”¨ Custom Alert)
function toggleLock(lockState) {
    const inputPass = document.getElementById('settings-password').value;
    const statusEl = document.getElementById('lock-status');
    
    if (lockState) {
        // === ä¸Šé– ===
        if (!inputPass) { 
            showCustomAlert("ã€Œè¼¸å…¥å¯†ç¢¼ï¼Œä»¥ä¸Šé–è–åŸŸã€‚ã€", "KEY REQUIRED");
            return; 
        }
        
        const oldPassword = currentPassword;
        currentPassword = inputPass;
        isUnlocked = false;
        
        // ä¿å­˜æ–°å¯†ç¢¼
        localStorage.setItem('app_password', currentPassword);
        localStorage.setItem('is_unlocked', 'false');
        
        // é‡æ–°åŠ å¯†æ‰€æœ‰è³‡æ–™
        reEncryptAllData(oldPassword, currentPassword);
        
        statusEl.innerText = "LOCKED (åŠ å¯†ä¸­)";
        statusEl.className = "status-badge locked";
        
        showCustomAlert("ã€Œè–åŸŸå·²ä¸Šé–ï¼Œè³‡æ–™å·²åŠ å¯†ã€‚ã€", "LOCKED");
        
    } else {
        // === è§£é– ===
        if (!inputPass) { 
            showCustomAlert("ã€Œè¼¸å…¥å¯†ç¢¼ï¼Œä»¥è§£é–è–åŸŸã€‚ã€", "KEY REQUIRED");
            return; 
        }
        
        if (!currentPassword) {
            showCustomAlert("ã€Œè–åŸŸå°šæœªè¨­å®šå¯†ç¢¼ï¼Œç„¡éœ€è§£é–ã€‚ã€", "NOTICE");
            return;
        }
        
        // é©—è­‰å¯†ç¢¼
        if (inputPass !== currentPassword) {
            showCustomAlert("ã€Œå¯†ç¢¼éŒ¯èª¤ã€‚ã€", "ACCESS DENIED");
            return;
        }
        
        isUnlocked = true;
        localStorage.setItem('is_unlocked', 'true');
        
        statusEl.innerText = "UNLOCKED (å·²è§£å¯†)";
        statusEl.className = "status-badge unlocked";
        
        showCustomAlert("ã€Œè–åŸŸå·²è§£é–ï¼Œè³‡æ–™å·²è§£å¯†ã€‚ã€", "UNLOCKED");
    }
    
    // æ¸…ç©ºå¯†ç¢¼è¼¸å…¥æ¡†
    document.getElementById('settings-password').value = "";
    
    // åˆ·æ–°æ‰€æœ‰åˆ—è¡¨é¡¯ç¤º
    renderCrystalLogs();
    renderAlchemyLogs();
}

// 7. é é¢è¼‰å…¥æ™‚æ›´æ–°UIç‹€æ…‹
window.addEventListener('load', function() {
    const statusEl = document.getElementById('lock-status');
    if (currentPassword && !isUnlocked) {
        statusEl.innerText = "LOCKED (åŠ å¯†ä¸­)";
        statusEl.className = "status-badge locked";
    } else if (currentPassword && isUnlocked) {
        statusEl.innerText = "UNLOCKED (å·²è§£å¯†)";
        statusEl.className = "status-badge unlocked";
    } else {
        statusEl.innerText = "NO PASSWORD (ç„¡åŠ å¯†)";
        statusEl.className = "status-badge";
    }
})

// --- Core State ---
    const State = {
        stardust: parseInt(localStorage.getItem('stardust')) || 0,
        crystals: parseInt(localStorage.getItem('crystals')) || 0,
        mana: parseInt(localStorage.getItem('mana')) || 100,
        alchemyLogs: JSON.parse(localStorage.getItem('alchemy_logs')) || [],
        crystalLogs: JSON.parse(localStorage.getItem('crystal_logs')) || [],
        phaseSettings: JSON.parse(localStorage.getItem('phase_settings')) || {
            solar: 9,
            dusk: 18,
            sanctum: 23,
            void: 2
        },
        timer: null,
        timeLeft: 1500,
        sessionDuration: 1500, // ç”¨æ–¼è¨˜éŒ„æœ¬æ¬¡ä»»å‹™çš„å¯¦éš›ç¸½é•·åº¦
        phase: null,
        currentTask: ""
    };

    window.onload = () => {
        updateClock();
        setInterval(updateClock, 1000);
        updateUI();
        renderAlchemyLogs();
        renderCrystalLogs();
        
        // åˆå§‹åŒ–è¨­å®šé é¢çš„é¸å–®
        initPhaseSettingsUI();
    };

    // --- Phase Settings Logic ---
    
    function initPhaseSettingsUI() {
        // ç”Ÿæˆ 0-23 çš„é¸é …
        const generateOptions = (selectedVal) => {
            let html = '';
            for(let i=0; i<24; i++) {
                const val = i;
                const label = String(i).padStart(2,'0') + ":00";
                html += `<option value="${val}" ${val == selectedVal ? 'selected' : ''}>${label}</option>`;
            }
            return html;
        };

        document.getElementById('phase-solar-input').innerHTML = generateOptions(State.phaseSettings.solar);
        document.getElementById('phase-dusk-input').innerHTML = generateOptions(State.phaseSettings.dusk);
        document.getElementById('phase-sanctum-input').innerHTML = generateOptions(State.phaseSettings.sanctum);
        document.getElementById('phase-void-input').innerHTML = generateOptions(State.phaseSettings.void);
    }

    function savePhaseSettings() {
        const newSettings = {
            solar: parseInt(document.getElementById('phase-solar-input').value),
            dusk: parseInt(document.getElementById('phase-dusk-input').value),
            sanctum: parseInt(document.getElementById('phase-sanctum-input').value),
            void: parseInt(document.getElementById('phase-void-input').value)
        };
        
        State.phaseSettings = newSettings;
        localStorage.setItem('phase_settings', JSON.stringify(newSettings));
        
        // ç«‹å³æ›´æ–°ç‹€æ…‹
        State.phase = null; // å¼·åˆ¶åˆ·æ–°
        updateClock();
        showCustomAlert("ã€Œè–åŸŸå·²ç‚ºä½ é‡å¡‘ã€‚ã€", "SETTINGS COMPLETE");
    }

    function resetPhaseSettings() {
        const defaultSettings = { solar: 9, dusk: 18, sanctum: 23, void: 2 };
        State.phaseSettings = defaultSettings;
        localStorage.setItem('phase_settings', JSON.stringify(defaultSettings));
        initPhaseSettingsUI();
        State.phase = null;
        updateClock();
        showCustomAlert("ã€Œè–åŸŸå·²é‡å¡‘ç‚ºåˆå§‹å€¼ã€‚ã€", "RESET COMPLETE");
    }

    // Navigation
    function switchTab(tabName) {
        document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`page-${tabName}`).classList.add('active');
        const icons = { 'home': 0, 'focus': 1, 'alchemy': 2, 'release': 3, 'settings': 4 };
        document.querySelectorAll('.nav-item').forEach((el, index) => {
            if(index === icons[tabName]) el.classList.add('active');
            else el.classList.remove('active');
        });
    }

    // Time & Phase (Updated Logic)
    function updateClock() {
        const now = new Date();
        const h = now.getHours();
        const m = now.getMinutes();
        const timeStr = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        const timeDisplay = document.getElementById('real-time');
        if(timeDisplay) timeDisplay.innerText = timeStr;

        // è™•ç†è·¨åˆå¤œæƒ…æ³
        const isInRange = (curr, start, next) => {
            if (start < next) {
                return curr >= start && curr < next;
            } else {
                return curr >= start || curr < next;
            }
        };

        const ps = State.phaseSettings;
        let phase = 'void';

        // ä¾åºæª¢æŸ¥æ¯å€‹éšæ®µ (Solar -> Dusk -> Sanctum -> Void)
        if (isInRange(h, ps.solar, ps.dusk)) {
            phase = 'solar';
        } else if (isInRange(h, ps.dusk, ps.sanctum)) {
            phase = 'dusk';
        } else if (isInRange(h, ps.sanctum, ps.void)) {
            phase = 'sanctum';
        } else {
            phase = 'void';
        }
        
        // è™•ç†ç¤¾äº¤é–
        const socialModule = document.getElementById('module-social');
        if (phase === 'sanctum' || phase === 'void') {
            socialModule.classList.add('locked');
        } else {
            socialModule.classList.remove('locked');
        }

        if (State.phase !== phase) {
            State.phase = phase;
            updateTheme(phase);
        }

        // æ—¥æ™·
        const totalMin = h * 60 + m;
        let percent = 0;
        // å‡è¨­ç™½å¤©æ˜¯ 6:00 - 18:00 (æ—¥æ™·é¡¯ç¤ºç”¨)
        if (h >= 6 && h < 18) percent = (totalMin - 360) / 720;
        else percent = (h >= 18) ? 1 : 0;
        
        const angle = Math.PI * (1 - percent);
        const x = 110 + 100 * Math.cos(angle);
        const y = 110 - 100 * Math.sin(angle);
        const celestial = document.getElementById('celestial-body');
        if(celestial) { celestial.setAttribute('cx', x); celestial.setAttribute('cy', y); }
    }

    function updateTheme(phase) {
        const root = document.documentElement;
        let color, name, glow;
        switch(phase) {
            case 'solar': color = '#c29d7c'; name = 'SOLAR (å‰µé€ )'; glow = '8px'; break;
            case 'dusk': color = '#345f4c'; name = 'DUSK (ç¤¾äº¤)'; glow = '12px'; break;
            case 'sanctum': color = '#6a708a'; name = 'SANCTUM (çµç•Œ)'; glow = '5px'; break;
            default: color = '#4b4a69'; name = 'VOID (ä¼‘çœ )'; glow = '2px'; break;
        }
        root.style.setProperty('--active-color', color);
        root.style.setProperty('--glow-spread', glow);
        const phaseName = document.getElementById('phase-name');
        if(phaseName) phaseName.innerText = name;
    }

    function adjustMana(val) {
        State.mana = Math.min(100, Math.max(0, State.mana + val));
        localStorage.setItem('mana', State.mana);
        updateUI();
    }

    // --- Pomodoro Logic ---
    function openTaskModal() { document.getElementById('task-modal').classList.add('open'); document.getElementById('micro-task-input').focus(); }
    function closeTaskModal() { document.getElementById('task-modal').classList.remove('open'); }
    
    function startTimer() {
        const input = document.getElementById('micro-task-input');
        State.currentTask = input.value || "Unknown Task";
        
        // è¼¸å…¥å¾Œç«‹åˆ»è®Šäº‚ç¢¼ç‰¹æ•ˆ (è¦–è¦ºæ•ˆæœ)
        if (isUnlocked && currentPassword) {
            input.value = encryptData(State.currentTask);
        }

        setTimeout(() => {
            closeTaskModal();
            input.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
            if (State.timer) clearInterval(State.timer);
            
            // [ä¿®æ”¹] è¨­å®šåˆå§‹æ™‚é–“èˆ‡ç´€éŒ„ç”¨çš„ç¸½æ™‚é•·
            State.timeLeft = 25 * 60;
            State.sessionDuration = 25 * 60; 

            document.getElementById('btn-start').innerText = "CHARGING...";
            document.getElementById('btn-start').style.borderColor = "var(--color-alert)";
            document.getElementById('btn-start').style.color= "var(--color-alert)";
            document.getElementById('btn-start').style.textShadow= "var(--color-alert)";
            
            State.timer = setInterval(() => {
                State.timeLeft--;
                const m = Math.floor(State.timeLeft / 60).toString().padStart(2,'0');
                const s = (State.timeLeft % 60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `${m}:${s}`;
                
                if (State.timeLeft <= 0) {
                    completeCycle();
                }
            }, 1000);
        }, 500);
    }
    
    function reduceDifficulty() { 
        State.timeLeft = Math.floor(State.timeLeft / 2); 
        State.sessionDuration = State.timeLeft; //è‹¥æ¸›å°‘æ™‚é–“ï¼Œç´€éŒ„çš„æ™‚é•·ä¹Ÿæ‡‰åŒæ­¥æ›´æ–°
    }

    function completeCycle() {
        clearInterval(State.timer);
        State.crystals++;
        State.stardust += 50;

        // --- æ–°å¢åŠŸèƒ½ï¼šæ’­æ”¾éŸ³æ•ˆ ---
        const audio = document.getElementById('timer-sound');
        if (audio) {
            // é‡ç½®æ’­æ”¾æ™‚é–“ï¼Œç¢ºä¿æ¯æ¬¡éƒ½èƒ½å¾é ­æ’­æ”¾
            audio.currentTime = 0;
            // å˜—è©¦æ’­æ”¾ï¼Œä¸¦æ•æ‰éŒ¯èª¤ (é˜²æ­¢ç€è¦½å™¨é˜»æ“‹è‡ªå‹•æ’­æ”¾å ±éŒ¯)
            audio.play().catch(e => console.log("Audio play prevented:", e));
        }

        // è¨ˆç®—å¯¦éš›ç´€éŒ„çš„æ™‚é•·å­—ä¸²
        const durM = Math.floor(State.sessionDuration / 60).toString().padStart(2,'0');
        const durS = (State.sessionDuration % 60).toString().padStart(2,'0');
        const durationStr = `${durM}:${durS}`;

        // å„²å­˜æ°´æ™¶ç´€éŒ„
        const now = new Date();
        const log = {
            id: Date.now(),
            task: encryptData(State.currentTask), // åŠ å¯†å­˜å„²
            dateStr: `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`,
            duration: durationStr // [ä¿®æ”¹] ä½¿ç”¨å‹•æ…‹è¨ˆç®—çš„æ™‚é–“
        };
        State.crystalLogs.push(log);
        
        saveData(); 
        updateUI(); 
        renderCrystalLogs();
        
        showCustomAlert("ã€Œå·²æˆåŠŸå……èƒ½ä¸€é¡†æ°´æ™¶ã€‚ã€Stardust +50", "CRYSTAL CHARGED");
        
        document.getElementById('btn-start').innerText = "CRYSTAL CHARGING (æ°´æ™¶å……èƒ½)";
        document.getElementById('btn-start').style.borderColor = "var(--active-color)";
        document.getElementById('btn-start').style.color= "var(--active-color)";
        document.getElementById('btn-start').style.textShadow= "var(--active-color)";
        document.getElementById('micro-task-input').value = ""; // æ¸…ç©ºè¼¸å…¥
    }

    function resetCrystalSlots() {
        State.crystals = 0; // é‡ç½®æ§½ä½è¨ˆæ•¸ï¼Œä¸å½±éŸ¿æ—¥èªŒ
        saveData();
        updateUI();
    }

    // --- Crystal Archive Logic ---
    function renderCrystalLogs() {
        const container = document.getElementById('crystal-archive');
        container.innerHTML = "";
        State.crystalLogs.forEach((log, index) => {
            const crystal = document.createElement('div');
            crystal.className = 'archived-crystal';
            // æ ¹æ“šæ˜¯å¦è§£é–æ±ºå®šé¡¯ç¤ºå…§å®¹ (é›–ç„¶æ°´æ™¶åªæ˜¯åœ–æ¨™ï¼Œä½†é»é–‹å¾Œçš„å…§å®¹éœ€è¦è§£å¯†)
            crystal.onclick = () => showCrystalDetail(log, index);
            container.appendChild(crystal);
        });
    }

    function showCrystalDetail(log, index) {
        const modal = document.getElementById('crystal-detail-modal');
        const content = document.getElementById('crystal-detail-content');
        const deleteBtn = document.getElementById('btn-delete-crystal');

        // è§£å¯†ä»»å‹™
        const taskText = decryptData(log.task);

        content.innerHTML = `
            <p>ID: #${index + 1}</p>
            <p>TIME: ${log.dateStr}</p>
            <p>DURATION: ${log.duration}</p>
            <hr style="border-color:#333; margin: 10px 0;">
            <p style="color:var(--active-color); font-weight:bold;">TASK:<br>${taskText}</p>
        `;

        // é€™è£¡éœ€è¦ä¿®æ”¹ç‚ºä½¿ç”¨ custom confirm
        deleteBtn.onclick = () => {
            showCustomConfirm("ã€Œç¢ºå®šè¦ç§»é™¤æ­¤é¡†æ°´æ™¶å—ï¼Ÿã€", () => {
                State.crystalLogs.splice(index, 1);
                saveData();
                renderCrystalLogs();
                modal.classList.remove('open');
            }, "DELETE CRYSTAL");
        };

        modal.classList.add('open');
    }

    function clearCrystalLogs() {
        showCustomConfirm("ã€Œç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ°´æ™¶æ”¶è—å—ï¼Ÿã€", () => {
            State.crystalLogs = [];
            saveData();
            renderCrystalLogs();
        }, "RESET COLLECTION");
    }

    // --- Alchemy Logic ---
    function transmute() {
        const rawInput = document.getElementById('alchemy-raw');
        const refinedInput = document.getElementById('alchemy-refined');
        
        const rawVal = rawInput.value;
        const refinedVal = refinedInput.value;

        if (!rawVal || !refinedVal) return;

        // è¦–è¦ºä¸Šçš„åŠ å¯† (è¼¸å…¥æ¡†è®Šæˆäº‚ç¢¼)
        if (isUnlocked && currentPassword) {
            rawInput.value = encryptData(rawVal);
            refinedInput.value = encryptData(refinedVal);
        }

        setTimeout(() => {
            const now = new Date();
            const entry = {
                id: Date.now(),
                raw: encryptData(rawVal), // åŠ å¯†å­˜å„²
                refined: encryptData(refinedVal), // åŠ å¯†å­˜å„²
                dateStr: `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`,
                timeStr: `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`
            };
            State.alchemyLogs.unshift(entry);
            State.stardust += 20;
            
            saveData(); 
            rawInput.value = ''; 
            refinedInput.value = '';
            renderAlchemyLogs(); 
            updateUI();
        }, 500);
    }

    function renderAlchemyLogs() {
        const shelf = document.getElementById('archive-shelf');
        if (State.alchemyLogs.length === 0) { shelf.innerHTML = '<div style="text-align:center;color:#333;padding:20px;">[ NO DATA ARCHIVED ]</div>'; return; }
        
        shelf.innerHTML = State.alchemyLogs.map((log, index) => {
            // è§£å¯†é¡¯ç¤º
            const rawText = decryptData(log.raw);
            const refinedText = decryptData(log.refined);

            return `
            <div class="archive-item" onclick="this.classList.toggle('expanded')">
                <div class="delete-btn-small" onclick="deleteAlchemyLog(event, ${index})">Ã—</div>
                <div style="font-size:0.7rem; color:#555; font-family:var(--font-rune); margin-bottom:4px;">${log.dateStr} <span style="float:right">${log.timeStr}</span></div>
                <div style="font-size:0.9rem; color:var(--color-solar); text-align:center; font-family:var(--font-rune); text-shadow: 0 0 8px var(--color-solar);">Result: ${refinedText}</div>
                <div style="text-align:center;" class="archive-details">
                    <span style="color:var(--color-void); font-size:0.7rem; font-family:var(--font-rune);">[ Material: ${rawText} ]</span>
                </div>
                <div style="color:var(--color-text-dim); text-align:center; font-size:0.7rem; font-family:var(--font-rune);">[ ALCHEMY RESULT: SUCCESSFUL & IMMACULATE ]</div>
            </div>
        `}).join('');
    }

    function deleteAlchemyLog(e, index) {
        e.stopPropagation(); // é˜²æ­¢è§¸ç™¼å±•é–‹
        showCustomConfirm("ã€Œç¢ºå®šè¦åˆªé™¤æ­¤å‰‡ç…‰é‡‘ç´€éŒ„å—ï¼Ÿã€", () => {
            State.alchemyLogs.splice(index, 1);
            saveData();
            renderAlchemyLogs();
        }, "DELETE DATA");
    }

    function clearAlchemyLogs() {
        showCustomConfirm("ã€Œç¢ºå®šè¦æ¸…ç©ºç…‰é‡‘çˆå—ï¼Ÿã€", () => {
            State.alchemyLogs = []; 
            saveData(); 
            renderAlchemyLogs();
        }, "RESET CRUCIBLE");
    }

    // --- Incinerator Logic ---
    function shredEmotion() {
        const area = document.getElementById('confess-text');
        const text = area.value;
        if(!text) return;

        // 1. è½‰ç‚ºäº‚ç¢¼ (ä½¿ç”¨éš¨æ©ŸKeyæˆ–ç•¶å‰KeyåŠ å¯†ï¼Œé‡é»æ˜¯è¦–è¦ºæ•ˆæœ)
        // é€™è£¡ç›´æ¥ç”¨éš¨æ©Ÿå­—ä¸²æ¨¡æ“¬ "ä¸å¯é€†éŠ·æ¯€" çš„éç¨‹
        const randomKey = Math.random().toString(36);
        const garbled = CryptoJS.AES.encrypt(text, randomKey).toString();
        
        area.value = garbled; // é¡¯ç¤ºäº‚ç¢¼
        area.style.color = "var(--color-alert)";
        area.style.transition = "all 1s";
        area.style.opacity = 0.5;

        // 2. éŠ·æ¯€
        setTimeout(() => {
            area.style.transform = "scale(0.95)";
            area.style.opacity = 0;
            
            setTimeout(() => {
                area.value = '';
                area.style.color = "#666";
                area.style.opacity = 1;
                area.style.transform = "scale(1)";
                State.stardust += 10;
                saveData(); updateUI();
                
                showCustomAlert("ã€Œæƒ…ç·’å·²ç„šæ¯€ï¼Œä½ ç¾åœ¨å¾ˆå®‰å…¨ã€‚ã€Stardust +10", "INCINERATION COMPLETE");
            }, 1000);
        }, 800);
    }

    function saveData() { 
        localStorage.setItem('stardust', State.stardust); 
        localStorage.setItem('crystals', State.crystals); 
        localStorage.setItem('alchemy_logs', JSON.stringify(State.alchemyLogs));
        localStorage.setItem('crystal_logs', JSON.stringify(State.crystalLogs));
    }

    function updateUI() {
        document.getElementById('stardust-display').innerText = State.stardust;
        const bar = document.getElementById('mana-bar');
        bar.style.width = `${State.mana}%`;
        bar.style.background = State.mana < 30 ? 'var(--color-alert)' : 'var(--color-dusk)';
        
        // æ°´æ™¶æ§½ä½é‚è¼¯ï¼š
        // 1->1, 2->2, 3->3, 4->4 (full), 5->1 (reset)
        let count = State.crystals;
        let filledCount = 0;
        if (count > 0) {
            filledCount = count % 4;
            if (filledCount === 0) filledCount = 4; // æ»¿4é¡†é¡¯ç¤ºå…¨äº®
            if (count > 4 && (count % 4 === 1)) filledCount = 1; // ç¬¬5é¡†é¡¯ç¤º1é¡†
        }

        for(let i=1; i<=4; i++) {
            const el = document.getElementById(`c${i}`);
            if(i <= filledCount) el.classList.add('filled'); else el.classList.remove('filled');
        }
    }

    // DATA MANAGEMENT (è³‡æ–™ç®¡ç†)
    function exportData() {
        // 1. æ”¶é›†æ‰€æœ‰é—œéµè³‡æ–™
        const backupData = {
            version: "3.8.2",
            timestamp: new Date().toISOString(),
            // æ ¸å¿ƒç´€éŒ„
            alchemy_logs: JSON.parse(localStorage.getItem('alchemy_logs') || "[]"),
            crystal_logs: JSON.parse(localStorage.getItem('crystal_logs') || "[]"),
            // è¨­å®šèˆ‡å¯†ç¢¼
            app_password: localStorage.getItem('app_password') || "",
            is_unlocked: localStorage.getItem('is_unlocked') || "false",
            // æ™‚é–“éšæ®µè¨­å®š
            phase_settings: JSON.parse(localStorage.getItem('phase_settings') || JSON.stringify({ solar: 9, dusk: 18, sanctum: 23, void: 2 })),
            // è²¨å¹£èˆ‡ç‹€æ…‹
            stardust: localStorage.getItem('stardust') || "0",
            crystals: localStorage.getItem('crystals') || "0",
            mana: localStorage.getItem('mana') || "100"
        };

        // 2. è½‰æ›ç‚º JSON å­—ä¸²
        const dataStr = JSON.stringify(backupData, null, 2);
        
        // 3. å»ºç«‹ä¸‹è¼‰é€£çµ
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        // 4. è¨­å®šæª”å (å«æ—¥æœŸ)
        const date = new Date();
        const dateStr = `${date.getFullYear()}${String(date.getMonth()+1).padStart(2,'0')}${String(date.getDate()).padStart(2,'0')}`;
        a.href = url;
        a.download = `STSA_backup_${dateStr}.json`;
        
        // 5. è§¸ç™¼ä¸‹è¼‰
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showCustomAlert("ã€Œè–åŸŸç´€éŒ„å·²å‚™ä»½ã€‚ã€", "EXPORT SUCCESS");
    }

    function importData(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);

                // é©—è­‰ç°¡å–®çš„æ ¼å¼ (æª¢æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„æ¬„ä½)
                if (!data.phase_settings && !data.alchemy_logs) {
                    throw new Error("Invalid Format");
                }

                showCustomConfirm("ã€Œç¢ºå®šåŒ¯å…¥æ­¤è–åŸŸç´€éŒ„å—ï¼Ÿç›®å‰çš„ç´€éŒ„å°‡è¢«è¦†è“‹ã€‚ã€", () => {
                    // é–‹å§‹é‚„åŸè³‡æ–™
                    if (data.alchemy_logs) localStorage.setItem('alchemy_logs', JSON.stringify(data.alchemy_logs));
                    if (data.crystal_logs) localStorage.setItem('crystal_logs', JSON.stringify(data.crystal_logs));
                    
                    // é‚„åŸå¯†ç¢¼
                    if (data.app_password !== undefined) localStorage.setItem('app_password', data.app_password);
                    if (data.is_unlocked !== undefined) localStorage.setItem('is_unlocked', data.is_unlocked);

                    // é‚„åŸæ™‚é–“è¨­å®š
                    if (data.phase_settings) localStorage.setItem('phase_settings', JSON.stringify(data.phase_settings));

                    // é‚„åŸæ•¸å€¼
                    if (data.stardust) localStorage.setItem('stardust', data.stardust);
                    if (data.crystals) localStorage.setItem('crystals', data.crystals);
                    if (data.mana) localStorage.setItem('mana', data.mana);

                    // é‡æ–°æ•´ç†é é¢ä»¥å¥—ç”¨è®Šæ›´
                    showCustomAlert("ã€Œè–åŸŸæˆåŠŸé‡å¡‘ï¼Œè–åŸŸå³åˆ»é‡å•Ÿã€‚ã€", "IMPORT COMPLETE");
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);

                }, "OVERWRITE WARNING");

            } catch (err) {
                console.error(err);
                showCustomAlert("ã€Œæ ¼å¼éŒ¯èª¤æˆ–ææ¯€ã€‚ã€", "IMPORT FAILED");
            }
            
            // æ¸…ç©º input è®“åŒå€‹æª”æ¡ˆå¯ä»¥å†æ¬¡è¢«é¸å–
            inputElement.value = '';
        };
        reader.readAsText(file);
    }

    function wipeAllData() {
        showCustomConfirm("ã€Œå³å°‡æ¸…ç©ºè–åŸŸã€‚ç¢ºå®šåŸ·è¡Œï¼Ÿã€", () => {
            // å†æ¬¡ç¢ºèª (Double Confirmation)
            setTimeout(() => {
                const doubleCheck = confirm("ã€Œé€™é …æ“ä½œå°‡å¾¹åº•æ¸…ç©ºä¸¦é‡å¡‘è–åŸŸã€‚æ˜¯å¦ç¹¼çºŒï¼Ÿã€(è«‹è¨˜å¾—åœ¨æ¸…é™¤å¾Œé—œé–‰ä¸¦é‡å•Ÿæœ¬ç¨‹å¼ã€‚)");
                if (doubleCheck) {
                    localStorage.clear();
                    showCustomAlert("ã€Œè–åŸŸå·²é‡å¡‘ç‚ºåˆå§‹ç‹€æ…‹ã€‚ã€", "ALL RESET");
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                }
            }, 200);
        }, "CRITICAL WARNING");
    }
</script>
</body>
</html>